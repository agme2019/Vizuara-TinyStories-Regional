<div align="center">

  <h1> TinyStories Regional <img src="https://png.pngtree.com/png-vector/20220812/ourmid/pngtree-indian-flag-design-png-png-image_6108311.png" width="30"> </h1>
  <i>A Framework for Developing Regional SLMs as Proxies for Comparative Analysis</i>
  <img src="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3a1a36ff-6d9a-4ee7-9494-3ae38adfe134_1920x600.png" alt="Vizuara Logo" style="width:80%;">

  [![arXiv](https://img.shields.io/badge/arXiv-1234.56789-b31b1b.svg?style=flat)](https://arxiv.org/abs/1234.56789)
  [![Huggingfaces](https://img.shields.io/badge/%F0%9F%A4%97%20Hugging%20Face-Spaces-blue)](https://huggingface.co/TinyStories-Regional)

  [![nirvan](https://img.shields.io/badge/nirvan-black?logo=github&logoColor=white&labelColor=black&color=black&style=flat)](https://github.com/nirvan840)
  [![malhar](https://img.shields.io/badge/malhar-black?logo=github&logoColor=white&labelColor=black&color=black&style=flat)](https://github.com/malharinamdar)
  [![agnivo](https://img.shields.io/badge/agnivo-black?logo=github&logoColor=white&labelColor=black&color=black&style=flat)](https://github.com/agme2019)
  [![raj](https://img.shields.io/badge/üåê-rajdandekar-black?logo=globe&logoColor=white&labelColor=black&color=black&style=flat)](https://www.linkedin.com/in/raj-abhijit-dandekar-67a33118a/?originalSubdomain=in)
  
</div>
<br>

> [!IMPORTANT]
> * <i> Currently, models only support story completion based on starting prompts :) </i>
> * <i> Guides to using the repository, datasets and the models are below! </i>
> * <i> This repository provides resources and code for the Regional TinyStories framework, which extends the TinyStories approach ([Eldan & Li, 2023](https://arxiv.org/abs/2305.07759)) to three major Indian languages: Hindi, Marathi, and Bengali. Our framework enables training and inference with small language models (SLMs) containing as few as 5-50 million parameters. <i>


> [!NOTE]
> #### _A special thanks to_
> * <i> <a href="https://tensordock.com/">TensorDock</a> for providing GPU compute! Check them out for easy-to-deploy and affordable GPU/CPU VMs üíö </i>
> * <i> Microsoft for inspiring us with their original <a href="https://arxiv.org/abs/2305.07759">TinyStories</a> paper üíô </i>
> * <i> <a href="https://huggingface.co/sarvamai">Sarvam</a>, <a href="https://huggingface.co/TWO">SUTRA</a>, and <a href="https://karpathy.ai/">Andrej Karpathy</a> for their open-source efforts ‚ù§Ô∏è </i>

> [!WARNING]
> * Our TinyStories Regional paper will soon be on arXiv!
> * Any references to the paper below are currently not accessible

```sh
git clone https://github.com/nirvan840/Vizuara-TinyStories-Regional.git
```
```sh
pip install g4f[all] aiolimter transformers datasets huggingface_hub sentencepiece tiktoken wandb tqdm torch numpy 
```

---

<br> 

# üìö Table of Contents

- ### üóÇÔ∏è Dataset Generation
  - #### [‚úçÔ∏è Preparing Prompts](#preparing-prompts)
  - #### [üí¨ Prompting a LLM](#prompting-a-model)
- ### ‚öôÔ∏è Training SLMs
  - #### [üî§ Tokenizing Data](#tokenizing-data)
  - #### [üèãÔ∏è Training the Model](#training-the-model)
- ### üîç Inference and Evaluation
  - #### [ü§ñ SLM Inference](#inference-models-local-or-hf)
  - #### [üìä Evaluate Inference/Stories](#evaluate-inference-stories)
- ### üìà Results
  - #### [üí° Inference Examples](#inference-examples)
  - #### [üÜö Tokenizer Comparison](#tokenizer-comparison)
  - #### [‚úÖ A Fitting Use Case](#a-fitting-use-case)
- ### üí∞ Costs
  - #### [‚è±Ô∏è Training Time and Costs](#training-time-and-costs)
  - #### [üîÑ Replicating the Project](#replicating-the-project)

---

<br> 

# üóÇÔ∏è Dataset Generation 

> [!WARNING] 
> <i> This repository provides code to generate data by making API calls to SOTA models (4o, 4o-mini, Gemini-flash-1.5, etc.) using the [GPT-4-free (G4F)](https://github.com/xtekky/gpt4free) repository. This repository is provided for research purposes only. We do not intend to promote using this repository for large-scale dataset generation; respect all terms of service for any API or model you use. Ensure appropriate attribution and licensing for any generated content. Please read and follow official OpenAI/Gemini guidelines. </i>

> [!NOTE]
> - Our datasets for Hindi, Marathi and Bangla, generated using GPT-4o-mini, are open-sourced on our HF
> - Translated versions (Hindi and Bangla) of [Microsoft's TinyStories](https://huggingface.co/datasets/roneneldan/TinyStories) dataset can also be found on our HF
> - Translated versions (our Hindi ‚û°Ô∏è Bangla ; Hindi ‚û°Ô∏è Marathi ; Bangla ‚û°Ô∏è Hindi) will be soon on our HF

<h2 id="preparing-prompts">‚úçÔ∏è Preparing Prompts</h2>
<ul>
  <p><li>Each prompt is generated by sampling a unique set of a noun, a verb, an adjective and a feature</li></p>
  <p><li>To modify the list of nouns, verbs, etc., please modify <code>.txt</code> files at <code>prompting/prompt_gen/<i>&lt;lanauge&gt;</i></code></li></p>
  <p></p><li>Prompt templates/complexities can be referred to/modified through <code>prompting/prompt_gen/create_prompts.py</code>.</li> 
      <ul> <li>We compare various complexities in our paper and find <code>2+</code> to be optimal</li> </ul></p>
  <p><li>Unique (sampling is unique and not random) prompts can be generated by running <code>generate_prompts.py</code></li></p>
  <p><li>Generated prompts are written to a <code>.json</code> file. Sharding the file is recommended (below)</li></p>
</ul>

<i> To generate prompts please run: </i>
```sh
python prompting/prompt_gen/generate_prompts.py
```

<h2 id="prompting-a-model">üí¨ Prompting a LLM</h2>
<ul>
  <p><li>Prompts are read from the <code>.json</code> file/shards and "sent" to the specified LLM (using <a href="https://github.com/xtekky/gpt4free">G4F</a>)</li></p> 
  <p><li>Multithreaded API calls result in a max speed of <code>100 stories/min</code> for GPT-4o-mini and GPT-4o (occasionally).</li>
      <ul>
        <li>It is recommended number of threads = number of <code>4 x vCPUs</code></li>
        <li>Each thread writes to a common file. Once every 10% of total progress</li>
        <li><i>Optimal config</i>: <code>16 vCPUs</code>, running <code>4 sessions</code> concurrently (one for each shard), each with <code>16 threads</code></li>
      </ul></p>
  <p><li>Please look into <code>prompting/make_requests.py</code> for customizing the prompting schema</li>
      <ul>
        <li>Generated stories are written to <code>.json</code> files</li>
        <li>It is recommended to upload these files to HF for seamless integration while training models (below)</li>
      </ul>
  </p>
  <p><li>Please look into <code>prompting/request_helper.py</code> for a detailed look into the process</li>
      <ul>
        <li>API/LLM is prompted until a valid story is generated for each prompt</li>
        <li>Various regex (data cleanup) features</li>
      </ul></p>
</ul>

_Optimal prompt complexity/template:_
```sh
f```Write a short story in {language} (in Devanagari script) suitable for 5-to-7-year-old children.
Use simple, easy-to-understand words and limit the story to 3-4 short paragraphs (around 200-300 words).
The story should feature a clear beginning, middle, and end. Incorporate the verb "{verb}", the noun "{noun}", and the adjective "{adjective}" naturally into the story.
The story should also integrate the conclusion/tone "{feature1}" through actions and outcomes without directly stating the tone (e.g., do not use "‡§ñ‡•Å‡§∂" or similar words explicitly).
Remember to only use simple words and keep the story short!

Return the output as a JSON dictionary in the following format:
{
    "story": "your_generated_story"
}```
```
_To start the data generation process, please run the script:_
```sh
python prompting/make_requests.py
```
_TIPüí°: To run data generation in the background (detached VM session):_
```sh
tmux new -s session_name
```

---

<br>

# ‚öôÔ∏è Training Small Language Models (SLMs) 

> [!IMPORTANT]
> * It is essential that data is tokenized correctly <bos token> story <eos token> (read below)
> * Lower end GPUs <code>T4</code> (Collab), <code>P100</code> (Kaggle) can be used to train models in <code><24hrs</code> on our datasets!

> [!NOTE]
> * We utilize Andrej Karpathy's [nanoGPT](https://github.com/karpathy/nanoGPT) repository (with modifications) to train models
> * Our training script supports multi-GPU training (DDP), progress (TQDM) and logging support (WANDB), along with easy customizability


<h2 id="tokenizing-data">üî§ Tokenizing Data</h2>
<ul>
  <p><li>The <code>.json</code> files uploaded to HF in the previous stage server as our dataset</li></p>
  <p><li>The entire dataset is tokenized before training. Token IDs are stored in <code>.bin</code> files
      <ul>
        <li>The dataset to be tokenized can be chosen as per <code>training-inference/data/prepare.py line 38-46</code></li>
            <ul>
              <li>To tokenize a custom HF dataset, please look into lines <code>59-61</code> & <code>112-133</code></li>
            </ul>
        <li>The <code>.bin</code> files must be appropriately placed in a folder in <code>training-inference/data/</code></li>
            <ul>
              <li>This folder must be specified in <code>config.py</code> under the <code>dataset</code> variable</li>
            </ul>
        <li>Use <code>training-inference/data/decode_data.py</code> to decode and print first 500 tokens from a <code>.bin</code> file</li>
            <ul>
              <li> Ensure that the decoded tokens follow the format: <code>&lt;bos token&gt; story1 &lt;eos token&gt; &lt;bos token&gt; story2 &lt;eos token&gt;...</code></li>
            </ul>
      </ul>
  </li></p>
  <p><li>Tokenization is carried out by the script <code>training-inference/data/prepare.py</code></li></p>
  <p><li>We provide direct support for the following tokenizers:
      <ul>
        <li><a href="https://huggingface.co/sarvamai/sarvam-1">Sarvam (sarvam-1)</a> (Indic)</li>
        <li><a href="https://huggingface.co/TWO/sutra-mlt256-v2">Sutra (mlt256-v2)</a> (Indic)</li>
        <li><a href="https://github.com/openai/tiktoken">Tiktoken (GPT-2)</a> (English)</li>
      </ul>
  </li></p>
  <p><li>We provide easy support for any additional tokenizers available on HF.
      <ul>
        <li>Specify the new tokenizer along similar lines as<code>training-inference/data/prepare.py line 19-35</code></li>
        <li>For this to work, HF tokenizers must have valid <code>eos</code> and <code>bos</code> tokens</li>
      </ul>
  </li></p>
</ul>

_To tokenize an HF dataset, run the script:_
```sh
python training-inference/data/prepare.py
```

<h2 id="training-the-model">üèãÔ∏è Training the Model</h2>
<ul>
  <p><li>Training can be resumed for locally saved models as well as those from Vizuara-HF!</li></p>
  <p><li>Changes to the training configuration can be easily made through <code>training-inference/config.py</code></li></p>
  <p><li>Model weights are checkpointed every <code>eval_iters</code> and saved at <code>training-inference/out/</code> as <code>.pt</code> files</li></p>
</ul>

_To start training, run:_
```sh
# Single GPU
python training-inference/train.py training-inference/config.py
```
```sh
# Multi GPU (DDP)
torchrun --standalone --nproc_per_node=num_gpus training-inference/train.py training-inference/config.py
```
        
_Automated multi-config training:_
```sh
chmod +x training-inference/utils/automate-training.sh
./training-inference/utils/automate-training.sh
```

---

<br>

# üîç Inference and Evaluation

> [!IMPORTANT]
> * All evaluations are performed by SOTA LLMs, which may be "biased" towards a language
> * Thus, an <code>8/10</code> Hindi story might not be equivalent in "quality" to an <code>8/10</code> Bangla story
> * It is crucial to understand that as these models evolve, "ratings"/results will drift as compared to today

> [!NOTE]
> * Given the small size of the models, CPU inference is supported!
> * It is crucial to ensure tokenization occurs correctly (refer below)!
> * Data generation scripts are repurposed for evaluation of stories produced by SLMs

<h2 id="inference-models-local-or-hf">ü§ñ SLM Inference (Local or HF)</h2>
<ul>
  <p><li>Refer to the sample settings at the bottom of <code>training-inference/config.py</code></li>
      <ul>
        <li>Choose between locally saved models or those from our HF by toggling <code>load_from_hf</code></li>
        <li>Stories generated per prompt, temperature and top_k can be modified</li>
      </ul>
  <p>
  <p><li>Various tokenizers can be used for inference</li>
      <ul>
        <li>We provide direct support for Sarvam, SUTRA and Tikoken</li>
        <li>For adding your own tokenizers a complete understanding of <code>sample.py</code> is recommended :)</li>
      </ul>
  <p>
  <p><li>Multiple prompts (each on a new line) can be mentioned in a text file.
      <ul>
        <li>Refer to <code>training-inference/&lt;language&gt;-prompts.txt</code></li>
        <li>Model can be asked to generate multiple unique stories for each prompt.</li>
        <li><code>.txt</code> and <code>.json</code> outputs are supported.</li>
      </ul>
  </li></p>
</ul>

_To run inference, run the script:_
```sh
python training-inference/sample.py 
```

<h2 id="evaluate-inference-stories">üìä Evaluate Inference/Stories</h2>
<ul>
  <p><li>We repurpose the data generation code to send stories (using G4F) to SOTA LLMs for evaluation</code></li>
      <ul>
        <li>Set <code>evaluate</code> to True in <code>prompting/make_requests.py</code> and run the script</li>
      </ul>
  <p><li>Each of our SLMs is evaluated in the following manner:</code></li>
      <ul>
        <li>We prepared <code>1000</code> equivalent prompts for each language <code>training-inference/prompt-&lt;langugage&gt;.txt</code></li>
            <ul>
              <li>These <code>1000</code> prompts cover themes such as <code>Adventure, Creativity, Courage, etc..</code></li>
              <li>All the themes and other details can be found in <code>prompting/o1_inference-prompt-generation</code></li>
            </ul>
        <li>Each model produces <code>3 stories</code> per prompt which are sent to SOTA LLMs for eavluation</li>
      </ul>
  </p>
</ul>

_For each model, <code>3000</code> stories are evaluated according to the prompt:_ 
```sh
f'''{story}

The given {language} short story is for 5-7-year-old children.
Keeping in mind the target demographic, rate the story on a scale of 1-10 for context awareness, completeness, grammar, fluency, and creativity.
Evaluate context awareness by strictly assessing how well the storys middle and end align with the prompt "{prompt}".
Also, provide an overall rating on a scale of 1-10.

Only return a JSON dictionary in the following format: 
{
"context awareness": "your_context-awareness_score",
"completeness": "your_completeness_score",
"grammar": "your_grammar_score",
"fluency": "your_fluency_score",
"creativity": "your_creativity_score",
"overall": "your_overall_rating"
}'''
```

---

<br>

# üìà Results

<h2 id="inference-examples">üí° Inference Results</h2>

Our comprehensive evaluation across Hindi, Marathi, and Bengali story generation reveals systematic patterns in model scaling behavior while highlighting important language-specific characteristics:

| Language | Model Size (53-54M) | Grammar | Fluency | Context | Completeness | Overall |
|----------|---------------------|---------|---------|---------|--------------|---------|
| Hindi    | 512/6               | 8.912   | 8.554   | 7.734   | 7.783        | 8.158   |
| Bengali  | 512/6               | 8.816   | 8.420   | 7.507   | 7.645        | 8.016   |
| Marathi  | 512/6               | 8.723   | 8.106   | 7.245   | 7.407        | 7.807   |

Key findings:
- Small language models with only 53M parameters can generate coherent, grammatical stories in Indian languages
- Increasing model size from 4.5M to 153M parameters consistently improves performance across all languages
- Grammar scores show the highest performance, while context awareness remains most challenging
- The optimal configuration appears to be around 512 hidden units with 6 layers, balancing performance and efficiency

We evaluated performance using GPT-4 as a judge on four metrics: completeness, grammar, fluency, and creativity. Models were trained on a translated TinyStories as well as new synthetic content generated by prompting LLM.

<h2 id="tokenizer-comparison">üÜö Tokenizer Comparison</h2>

We compared three tokenizers‚ÄîSarvam, SUTRA, and Tiktoken‚Äîacross Hindi, Marathi, and Bengali, revealing significant differences in performance:

| Language | Tokenizer | Grammar | Fluency | Context | Overall |
|----------|-----------|---------|---------|---------|---------|
| Hindi    | Sarvam    | 8.912   | 8.554   | 7.734   | 8.158   |
| Hindi    | SUTRA     | 8.875   | 8.292   | 7.548   | 7.950   |
| Hindi    | Tiktoken  | 8.681   | 7.889   | 6.974   | 7.602   |
| Bengali  | Sarvam    | 8.816   | 8.420   | 7.507   | 8.016   |
| Bengali  | SUTRA     | 8.845   | 8.212   | 7.614   | 7.928   |
| Bengali  | Tiktoken  | 8.614   | 7.778   | 7.118   | 7.572   |
| Marathi  | Sarvam    | 8.723   | 8.106   | 7.245   | 7.807   |
| Marathi  | SUTRA     | 8.724   | 8.012   | 7.523   | 7.781   |
| Marathi  | Tiktoken  | 8.451   | 7.524   | 7.014   | 7.374   |

Key insights:
- Language-specific tokenizers (Sarvam, SUTRA) consistently outperform general-purpose alternatives (Tiktoken)
- Sarvam achieves the highest overall scores for Hindi and Bengali, with competitive performance for Marathi
- Tiktoken shows the lowest perplexity but struggles with capturing context and completeness
- Renyi entropy analysis shows Sarvam produces more concentrated token distributions (lower entropy values) compared to SUTRA
- MorphScore analysis reveals SUTRA better preserves morphological boundaries despite higher entropy



<h2 id="a-fitting-use-case">‚úÖ A Fitting Use Case</h2>

---

<br>

# üí∞ Costs

### _Soon!_

---

<br>

# üìù Citation
If you use Vizuara's TinyStories Regional in your research, please cite us using the following BibText template: 

```sh
@misc{TinyStories-Regional,
  author = {Nirvan Patil, Malhar Inamdar, Agnivo Gosai, Raj Dandekar},
  title = {TinyStories Regional: A Framework for Developing Regional SLMs as Proxies for Comparative Analysis},
  year = {2025},
  howpublished = {\url{https://github.com/nirvan840/Vizuara-TinyStories-Regional}},
  note = {Research conducted as part of Vizuara AI Labs}
}

```
